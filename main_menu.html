<!DOCTYPE html>
<html lang="en">
    <head>
        <!--Set the meta tags-->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!--Title-->
        <title>ReignFall Main Menu</title>
        <link rel="icon" type="image/x-icon" href="css/assets/images/logo_favicon.png">

        <!--CSS Import-->
        <link rel="stylesheet" href="css/theme.css">
        <link rel="stylesheet" href="css/terminal.css">
        <link rel="stylesheet" href="css/main_menu.css">
        <link rel="stylesheet" href="css/inventory.css">
        <!-- checking for logged in status-->
        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                let loggedIn = localStorage.getItem("loggedIn");
                let sessionToken = localStorage.getItem("sessionToken");
                let userID = localStorage.getItem("userID");
            
                if (loggedIn !== "true" || !sessionToken || !userID) {
                    window.location.href = "index.html";
                    return;
                }
            
                // Verify the session token in the database
                let query = `SELECT * FROM user_sessions WHERE userID='${userID}' AND session_token='${sessionToken}' AND expires_at > NOW() LIMIT 1`;
                let params = new URLSearchParams();
                params.append('hostname', 'localhost');
                params.append('username', 'jdonnelly73');
                params.append('password', 'CHZHy02qM20fcLVt');
                params.append('database', 'CSC1034_CW_39');
                params.append('query', query);
            
                try {
                    let response = await fetch('includes/db_connect.php', { method: 'POST', body: params });
                    let result = await response.json();
                    if (!(result.data && result.data.length > 0)) {
                        localStorage.removeItem("loggedIn");
                        localStorage.removeItem("userID");
                        localStorage.removeItem("sessionToken");
                        window.location.href = "index.html";
                    }
                } catch (error) {
                    console.error("Session verification error:", error);
                    window.location.href = "index.html";
                }
            });
            </script>
            
            
    </head>
    <body>
        <!-- Main Container Div -->
        <div id="main-container">

            <!-- Game Title -->
            <div id="title">
                <h1><img src="css/assets/images/reignfall-logo.png" alt="Logo for Reignfall" title="Logo for Reignfall"width="40%" ></h1>
            </div>

            <!-- Text-Based Menu -->     
            <div id="main-menu">

                <!-- Inventory (Temporarily Here)-->
                <div id="inventory" class="inventory-outer-container">
                   <!-- intentionally left blank  - this is no longer hardcoded. see database table (tools) to add/delete VIEW ON SERVER!-->
                </div>


                <div id="output-terminal">
                    <h2>Main Menu</h2>
                    <ol>
                        <li>Start Game</li>
                        <li>Load Game</li>
                        <li>Settings</li>
                        <li>Logout</li>
                    </ol>
                </div>

                <!-- Get Users input From the Menu -->
           
                <div id="input-terminal">
                    <div class="input-wrapper">
                        <input type="text" id="user-input" placeholder="Type here...">
                    </div>
                </div>
            </div>

        </div>
   
        <!-- JavaScript Import -->
        <script type="module" src="js/menu.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                fetch('includes/get_tools.php') // Ensure correct path to PHP file
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('inventory');
                        if (!container) return;
            
                        container.innerHTML = "";
            
                        if (!data || data.length === 0) {
                            container.textContent = "No tools found in the inventory.";
                        } else {
                            data.forEach(tool => {
                                const toolDiv = document.createElement('div');
                                toolDiv.classList.add('inventory-item-container');
            
                                const img = document.createElement('img');
                                img.src = tool.itemImgThumbnail;
                                img.alt = tool.itemName;
                                img.title = tool.itemName;
            
                                // Create the details div
                                const detailsDiv = document.createElement('div');
                                detailsDiv.classList.add('inventory-item-details');
            
                                const nameElement = document.createElement('strong');
                                nameElement.textContent = tool.itemName;
            
                                const descriptionElement = document.createElement('p');
                                descriptionElement.classList.add('inventory-description');
                                descriptionElement.textContent = tool.itemDescription || 'No description available';
            
                                detailsDiv.appendChild(nameElement);
                                detailsDiv.appendChild(descriptionElement);
            
                                toolDiv.appendChild(img);
                                toolDiv.appendChild(detailsDiv);
                                container.appendChild(toolDiv);
            
                                // Handle click to expand/collapse
                                toolDiv.addEventListener('click', () => {
                                    // Close any other expanded items
                                    document.querySelectorAll('.inventory-item-container').forEach(item => {
                                        if (item !== toolDiv) {
                                            item.classList.remove('expanded');
                                            const desc = item.querySelector('.inventory-description');
                                            if (desc) {
                                                desc.classList.remove('show');
                                                desc.classList.remove('marquee');
                                            }
                                        }
                                    });
            
                                    // Toggle the clicked item s
                                    toolDiv.classList.toggle('expanded');
            
                                    // If collapsing, immediately hide description
                                    if (!toolDiv.classList.contains('expanded')) {
                                        descriptionElement.classList.remove('show');
                                        descriptionElement.classList.remove('marquee');
                                    } else {
                                        // If expanding, show description after delay
                                        setTimeout(() => {
                                            if (toolDiv.classList.contains('expanded')) {
                                                descriptionElement.classList.add('show');
                                                
                                                // Check if the description text is wider than its container
                                                // and apply marquee effect if needed
                                                setTimeout(() => {
                                                    // Need another timeout to ensure the element is rendered with proper styles
                                                    const descWidth = descriptionElement.scrollWidth;
                                                    const containerWidth = descriptionElement.clientWidth;
                                                    
                                                    if (descWidth > containerWidth) {
                                                        descriptionElement.classList.add('marquee');
                                                    } else {
                                                        descriptionElement.classList.remove('marquee');
                                                    }
                                                }, 50);
                                            }
                                        }, 500);
                                    }
                                });
                            });
                        }
                    })
                    .catch(err => {
                        console.error("Error fetching tools:", err);
                    });
            });
        </script>
    </body>
</html>